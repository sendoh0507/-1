<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“š OOå­¸æ ¡ (èª²ç¨‹) é»åç‰ˆ ğŸ“š</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      display: flex;
      justify-content: center;
      background: #f0f0f0;
      margin: 0;
    }
    .container {
      width: 100%;
      max-width: 480px;
      background: white;
      padding: 12px 16px 20px 16px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    h2 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 12px;
      user-select: none;
    }
    .top-panel {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
      margin-bottom: 8px;
      align-items: center;
    }
    .top-panel input,
    .top-panel select,
    .top-panel button {
      font-size: 14px;
      padding: 6px 8px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .top-panel input:focus,
    .top-panel select:focus,
    .top-panel button:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 4px #4a90e2;
    }
    .top-panel button {
      cursor: pointer;
      background-color: #4a90e2;
      color: white;
      border: none;
      transition: background-color 0.3s ease;
    }
    .top-panel button:hover {
      background-color: #357abd;
    }
    #teacherInput {
      border-radius: 4px;
    }
    #studentCount {
      grid-column: 6 / 7;
      text-align: right;
      font-weight: 600;
      font-size: 14px;
      user-select: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      table-layout: fixed;
      user-select: none;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 4px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background-color: #e0e0e0;
      font-weight: 600;
    }
    /* å›ºå®šå­¸ç”Ÿå§“åæ¬„ */
    td.sticky-name {
      position: sticky;
      left: 0;
      background: #fafafa;
      font-weight: 600;
      z-index: 2;
      width: 120px;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* é»åæ ¼ */
    td.day-cell {
      cursor: pointer;
      user-select: none;
      width: 30px;
      height: 30px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    td.day-cell.signed {
      background-color: #b2f2bb;
      color: #1a5e19;
      font-weight: bold;
    }
    td.day-cell:hover {
      background-color: #d2f0d8;
    }
    /* åˆªé™¤æŒ‰éˆ• */
    td.delete-cell button {
      padding: 4px 6px;
      font-size: 12px;
      background-color: #f44336;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 3px;
      user-select: none;
    }
    td.delete-cell button:hover {
      background-color: #c13024;
    }
    /* æ‰‹æ©Ÿèª¿æ•´ */
    @media (max-width: 480px) {
      .top-panel {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
      td.sticky-name {
        width: 100px;
        font-size: 13px;
      }
      td.day-cell {
        width: 26px;
        height: 26px;
        font-size: 12px;
      }
      h2 {
        font-size: 20px;
      }
      .top-panel input,
      .top-panel select,
      .top-panel button {
        font-size: 13px;
        padding: 5px 6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="titleHeader">ğŸ“š OOå­¸æ ¡ (èª²ç¨‹) é»åç‰ˆ ğŸ“š</h2>

    <!-- ç¬¬ä¸€æ’ -->
    <div class="top-panel" style="margin-bottom:10px;">
      <select id="schoolSelect" title="é¸æ“‡å­¸æ ¡"></select>
      <button id="btnAddSchool" title="æ–°å¢å­¸æ ¡">æ–°å¢å­¸æ ¡</button>
      <button id="btnDelSchool" title="åˆªé™¤å­¸æ ¡">åˆªé™¤å­¸æ ¡</button>
      <input id="courseInput" type="text" placeholder="èª²ç¨‹åç¨±" title="è¼¸å…¥èª²ç¨‹åç¨±" />
      <button id="btnSetCourse" title="è¨­å®šèª²ç¨‹">è¨­å®šèª²ç¨‹</button>
      <input id="teacherInput" type="text" placeholder="è€å¸«" title="è¼¸å…¥è€å¸«åç¨±" />
    </div>

    <!-- ç¬¬äºŒæ’ -->
    <div class="top-panel" style="margin-bottom:12px;">
      <select id="yearSelect" title="é¸æ“‡å¹´ä»½"></select>
      <select id="monthSelect" title="é¸æ“‡æœˆä»½"></select>
      <select id="weekSelect" title="é¸æ“‡é€±æ¬¡"></select>
      <input id="studentInput" type="text" placeholder="æ–°å¢å­¸ç”Ÿ" title="è¼¸å…¥å­¸ç”Ÿå§“å" />
      <button id="btnAddStudent" title="æ–°å¢å­¸ç”Ÿ">æ–°å¢</button>
      <div id="studentCount">ğŸ‘¥ å…± 0 ä½å­¸ç”Ÿ</div>
    </div>

    <!-- é»åè¡¨ -->
    <table>
      <thead>
        <tr>
          <th>å­¸ç”Ÿå§“å</th>
          <th id="d1">ä¸€<br>-</th>
          <th id="d2">äºŒ<br>-</th>
          <th id="d3">ä¸‰<br>-</th>
          <th id="d4">å››<br>-</th>
          <th id="d5">äº”<br>-</th>
          <th id="d6">å…­<br>-</th>
          <th id="d7">æ—¥<br>-</th>
          <th>åˆªé™¤</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    // è®Šæ•¸åˆå§‹åŒ–
    const schoolSelect = document.getElementById("schoolSelect");
    const btnAddSchool = document.getElementById("btnAddSchool");
    const btnDelSchool = document.getElementById("btnDelSchool");
    const courseInput = document.getElementById("courseInput");
    const btnSetCourse = document.getElementById("btnSetCourse");
    const teacherInput = document.getElementById("teacherInput");
    const yearSelect = document.getElementById("yearSelect");
    const monthSelect = document.getElementById("monthSelect");
    const weekSelect = document.getElementById("weekSelect");
    const studentInput = document.getElementById("studentInput");
    const btnAddStudent = document.getElementById("btnAddStudent");
    const studentCount = document.getElementById("studentCount");
    const tableBody = document.getElementById("tableBody");
    const titleHeader = document.getElementById("titleHeader");

    // æœ¬åœ°å­˜å„² key
    const STORAGE_KEY = "attendanceData";

    // è³‡æ–™çµæ§‹
    // {
    //   schools: {
    //     "OOå­¸æ ¡": {
    //       course: "èª²ç¨‹å",
    //       teacher: "è€å¸«å",
    //       students: ["å­¸ç”Ÿ1", "å­¸ç”Ÿ2", ...],
    //       attendance: {
    //         "YYYY-MM-W": {
    //           "å­¸ç”Ÿ1": [false, true, false, ...], // 7 å¤©é»åç‹€æ…‹ (å‘¨ä¸€=0,...å‘¨æ—¥=6)
    //           ...
    //         }
    //       }
    //     }
    //   },
    //   currentSchool: "OOå­¸æ ¡"
    // }

    let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
      schools: {
        "OOå­¸æ ¡": {
          course: "èª²ç¨‹",
          teacher: "",
          students: [],
          attendance: {}
        }
      },
      currentSchool: "OOå­¸æ ¡"
    };

    // å·¥å…·ï¼šå­˜è³‡æ–™
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // åˆå§‹åŒ–å¹´ä»½é¸é …ï¼ˆå¾ä»Šå¹´é–‹å§‹ï¼Œå¾€å¾Œ5å¹´ï¼‰
    function initYearOptions() {
      const nowYear = new Date().getFullYear();
      yearSelect.innerHTML = "";
      for (let y = nowYear; y <= nowYear + 5; y++) {
        let opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y + " å¹´";
        yearSelect.appendChild(opt);
      }
    }

    // åˆå§‹åŒ–æœˆä»½é¸é …
    function initMonthOptions() {
      monthSelect.innerHTML = "";
      for (let m = 1; m <= 12; m++) {
        let opt = document.createElement("option");
        opt.value = m.toString().padStart(2, "0");
        opt.textContent = m + " æœˆ";
        monthSelect.appendChild(opt);
      }
    }

    // åˆå§‹åŒ–é€±æ¬¡é¸é … (1~5é€±)
    function initWeekOptions() {
      weekSelect.innerHTML = "";
      for (let w = 1; w <= 5; w++) {
        let opt = document.createElement("option");
        opt.value = w;
        opt.textContent = "ç¬¬ " + w + " é€±";
        weekSelect.appendChild(opt);
      }
    }

    // ä¾é¸å®šå¹´æœˆé€±å›å‚³ key: YYYY-MM-W
    function getSelectedKey() {
      return `${yearSelect.value}-${monthSelect.value}-${weekSelect.value}`;
    }

    // è¨ˆç®—è©²å¹´æœˆç¬¬å¹¾é€±çš„æ—¥æœŸï¼ˆå‘¨ä¸€ï½å‘¨æ—¥ï¼‰
    // å›å‚³é™£åˆ—ï¼š7 å€‹æ—¥æœŸè™Ÿç¢¼æˆ– '-' å­—ä¸²
    function calcWeekDates(year, month, week) {
      // é€±ä¸€ç‚ºè©²é€±èµ·å§‹æ—¥ï¼ˆæ ¹æ“šæœˆåˆå‘¨ä¸€ç®—èµ·ï¼‰
      // 1. æ‰¾è©²å¹´æœˆ1æ—¥æ˜ŸæœŸå¹¾
      const firstDate = new Date(year, month - 1, 1);
      const firstDay = firstDate.getDay(); // 0æ—¥...6å…­
      // é€±ä¸€ç‚º1ï¼Œå‘¨æ—¥ç‚º0ï¼ŒJSé€±æ—¥æ˜¯0ï¼Œéœ€è¦èª¿æ•´ç‚ºé€±ä¸€æ˜¯0
      // æˆ‘å€‘å°‡é€±ä¸€ç•¶ä½œ0ï¼Œé€±æ—¥ç•¶ä½œ6ï¼Œè½‰æ›:
      const offset = (firstDay === 0) ? 6 : firstDay - 1;
      // è©²é€±èµ·å§‹æ—¥è™Ÿç¢¼
      let startDay = 1 + (week - 1) * 7 - offset;
      let dates = [];
      for (let i = 0; i < 7; i++) {
        let d = startDay + i;
        if (d < 1 || d > daysInMonth(year, month)) {
          dates.push("-");
        } else {
          dates.push(d);
        }
      }
      return dates;
    }

    // æœˆä»½å¤©æ•¸
    function daysInMonth(year, month) {
      return new Date(year, month, 0).getDate();
    }

    // æ›´æ–°ä¸Šæ–¹æ¨™é¡Œ
    function updateTitle() {
      const school = data.currentSchool;
      const course = data.schools[school]?.course || "";
      titleHeader.textContent = `ğŸ“š ${school} (${course}) é»åç‰ˆ ğŸ“š`;
      // åŒæ­¥è¼¸å…¥æ¡†
      courseInput.value = course;
      teacherInput.value = data.schools[school]?.teacher || "";
    }

    // æ›´æ–°å­¸æ ¡ä¸‹æ‹‰é¸é …
    function updateSchoolOptions() {
      schoolSelect.innerHTML = "";
      for (const s of Object.keys(data.schools)) {
        let opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        schoolSelect.appendChild(opt);
      }
      schoolSelect.value = data.currentSchool;
    }

    // æ›´æ–°å¹´æœˆé€±é¸é …ï¼ˆè¨­å®šé è¨­ç‚ºä»Šå¤©æ‰€åœ¨çš„å¹´ã€æœˆã€é€±ï¼‰
    function updateDateSelections() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      // é è¨­å¹´ä»½èˆ‡æœˆä»½
      if (!yearSelect.value) yearSelect.value = year;
      if (!monthSelect.value) monthSelect.value = month.toString().padStart(2, "0");

      // è¨ˆç®—é€±æ¬¡
      // ç”¨ç•¶æœˆç¬¬ä¸€å¤©æ˜ŸæœŸä¸€ç‚ºåŸºæº–ï¼Œç®—ç•¶å‰æ—¥æœŸæ˜¯ç¬¬å¹¾é€±
      const day = now.getDate();
      const firstDate = new Date(year, month - 1, 1);
      const firstDay = firstDate.getDay();
      const offset = (firstDay === 0) ? 6 : firstDay - 1;
      let currentWeek = Math.floor((day + offset - 1) / 7) + 1;
      currentWeek = currentWeek > 5 ? 5 : currentWeek; // æœ€å¤šäº”é€±
      if (!weekSelect.value) weekSelect.value = currentWeek;
    }

    // æ¸²æŸ“ä¸Šæ–¹æ—¥æœŸæ¨™é¡Œ(å‘¨ä¸€~å‘¨æ—¥) èˆ‡ æ—¥æ•¸
    function renderDateHeaders() {
      const year = parseInt(yearSelect.value);
      const month = parseInt(monthSelect.value);
      const week = parseInt(weekSelect.value);
      const dates = calcWeekDates(year, month, week);
      for (let i = 1; i <= 7; i++) {
        const th = document.getElementById("d" + i);
        th.innerHTML = `${["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"][i-1]}<br>${dates[i-1]}`;
      }
    }

    // æ¸²æŸ“å­¸ç”Ÿè¡¨æ ¼
    function renderTable() {
      const school = data.currentSchool;
      const schoolData = data.schools[school];
      if (!schoolData) return;
      renderDateHeaders();

      const key = getSelectedKey();

      const attendance = schoolData.attendance[key] || {};
      const students = schoolData.students;

      studentCount.textContent = `ğŸ‘¥ å…± ${students.length} ä½å­¸ç”Ÿ`;
      tableBody.innerHTML = "";

      students.forEach((name, idx) => {
        const tr = document.createElement("tr");

        // å­¸ç”Ÿå§“åæ¬„(å›ºå®š)
        const tdName = document.createElement("td");
        tdName.textContent = name;
        tdName.classList.add("sticky-name");
        tr.appendChild(tdName);

        // 7 å¤©é»åæ ¼
        for(let i=0; i<7; i++) {
          const td = document.createElement("td");
          td.classList.add("day-cell");

          const signed = attendance[name]?.[i] || false;
          if(signed) td.classList.add("signed");

          td.addEventListener("click", () => {
            toggleAttendance(name, i);
          });
          td.textContent = signed ? "âœ”ï¸" : "";
          tr.appendChild(td);
        }

        // åˆªé™¤å­¸ç”Ÿæ¬„ä½
        const tdDel = document.createElement("td");
        tdDel.classList.add("delete-cell");
        const delBtn = document.createElement("button");
        delBtn.textContent = "åˆªé™¤";
        delBtn.title = "åˆªé™¤å­¸ç”Ÿ";
        delBtn.addEventListener("click", () => {
          if(confirm(`ç¢ºå®šè¦åˆªé™¤å­¸ç”Ÿã€Œ${name}ã€å—ï¼Ÿ`)) {
            deleteStudent(name);
          }
        });
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);

        tableBody.appendChild(tr);
      });
    }

    // åˆ‡æ›å­¸æ ¡
    function changeSchool(newSchool) {
      if (!data.schools[newSchool]) return;
      data.currentSchool = newSchool;
      saveData();
      updateTitle();
      updateSchoolOptions();
      renderTable();
    }

    // æ–°å¢å­¸æ ¡
    function addSchool() {
      const schoolName = prompt("è«‹è¼¸å…¥æ–°å­¸æ ¡åç¨±ï¼š");
      if (!schoolName) return alert("å­¸æ ¡åç¨±ä¸å¯ç©ºç™½");
      if (data.schools[schoolName]) return alert("è©²å­¸æ ¡å·²å­˜åœ¨");
      data.schools[schoolName] = { course: "", teacher: "", students: [], attendance: {} };
      data.currentSchool = schoolName;
      saveData();
      updateSchoolOptions();
      updateTitle();
      renderTable();
    }

    // åˆªé™¤å­¸æ ¡
    function deleteSchool() {
      const schoolName = data.currentSchool;
      if (schoolName === "OOå­¸æ ¡") return alert("ä¸å¯åˆªé™¤é è¨­å­¸æ ¡");
      if (confirm(`ç¢ºå®šåˆªé™¤å­¸æ ¡ã€Œ${schoolName}ã€åŠæ‰€æœ‰è³‡æ–™ï¼Ÿ`)) {
        delete data.schools[schoolName];
        data.currentSchool = Object.keys(data.schools)[0] || "OOå­¸æ ¡";
        saveData();
        updateSchoolOptions();
        updateTitle();
        renderTable();
      }
    }

    // è¨­å®šèª²ç¨‹
    function setCourse() {
      const school = data.currentSchool;
      data.schools[school].course = courseInput.value.trim();
      data.schools[school].teacher = teacherInput.value.trim();
      saveData();
      updateTitle();
      alert("èª²ç¨‹èˆ‡è€å¸«å·²è¨­å®š");
    }

    // æ–°å¢å­¸ç”Ÿ
    function addStudent() {
      const name = studentInput.value.trim();
      if (!name) return alert("è«‹è¼¸å…¥å­¸ç”Ÿå§“å");
      const school = data.currentSchool;
      if (data.schools[school].students.includes(name)) return alert("å­¸ç”Ÿå·²å­˜åœ¨");
      data.schools[school].students.push(name);
      saveData();
      studentInput.value = "";
      renderTable();
    }

    // åˆªé™¤å­¸ç”Ÿ
    function deleteStudent(name) {
      const school = data.currentSchool;
      const idx = data.schools[school].students.indexOf(name);
      if (idx !== -1) {
        data.schools[school].students.splice(idx, 1);
        // åŒæ™‚ç§»é™¤è©²å­¸ç”Ÿçš„é»åè³‡æ–™
        for (const key in data.schools[school].attendance) {
          delete data.schools[school].attendance[key][name];
        }
        saveData();
        renderTable();
      }
    }

    // é»åç‹€æ…‹åˆ‡æ›
    function toggleAttendance(studentName, dayIndex) {
      const school = data.currentSchool;
      const key = getSelectedKey();
      if (!data.schools[school].attendance[key]) {
        data.schools[school].attendance[key] = {};
      }
      if (!data.schools[school].attendance[key][studentName]) {
        data.schools[school].attendance[key][studentName] = [false,false,false,false,false,false,false];
      }
      const current = data.schools[school].attendance[key][studentName][dayIndex];
      data.schools[school].attendance[key][studentName][dayIndex] = !current;
      saveData();
      renderTable();
    }

    // äº‹ä»¶ç¶å®š
    btnAddSchool.addEventListener("click", addSchool);
    btnDelSchool.addEventListener("click", deleteSchool);
    btnSetCourse.addEventListener("click", setCourse);
    btnAddStudent.addEventListener("click", addStudent);

    schoolSelect.addEventListener("change", e => {
      changeSchool(e.target.value);
    });

    yearSelect.addEventListener("change", () => {
      renderTable();
    });
    monthSelect.addEventListener("change", () => {
      renderTable();
    });
    weekSelect.addEventListener("change", () => {
      renderTable();
    });

    teacherInput.addEventListener("change", () => {
      const school = data.currentSchool;
      data.schools[school].teacher = teacherInput.value.trim();
      saveData();
      updateTitle();
    });

    // åˆå§‹åŒ–é é¢
    function init() {
      updateSchoolOptions();
      updateTitle();
      initYearOptions();
      initMonthOptions();
      initWeekOptions();
      updateDateSelections();
      renderTable();
    }

    init();
  </script>
</body>
</html>
