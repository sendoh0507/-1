<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📚 OO學校 點名版 📚</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #2e2e2e;
      color: #fff;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #3c3f41;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 8px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }
    select, input {
      background: #1e1e1e;
      color: #fff;
    }
    button {
      background: #4caf50;
      color: #fff;
      cursor: pointer;
    }
    button.danger {
      background: #f44336;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      overflow-x: auto;
    }
    th, td {
      border: 1px solid #555;
      padding: 8px;
      text-align: center;
      min-width: 80px;
    }
    th {
      background: #2a2d2e;
      white-space: nowrap;
    }
    td.day-cell {
      cursor: pointer;
      background: #424242;
      user-select: none;
    }
    td.day-cell.signed {
      background: #81c784;
      font-weight: bold;
      color: #000;
    }
    #studentCount {
      margin-left: 10px;
      white-space: nowrap;
    }
    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        gap: 8px;
      }
      table {
        display: block;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📚 <span id="titleSchool">OO學校</span> <span id="titleCourse">(課程)</span> 點名版 📚</h1>
    <div class="controls">
      <select id="schoolSelect" style="min-width:150px;"></select>
      <button onclick="addSchool()">新增學校</button>
      <button onclick="deleteSchool()" class="danger">刪除學校</button>
      <input type="text" id="courseInput" placeholder="請輸入課程名稱" style="min-width:150px; flex-grow:1;">
      <button onclick="setCourse()">設定課程</button>
      <select id="yearSelect" style="min-width:90px;"></select>
      <select id="monthSelect" style="min-width:90px;"></select>
      <input type="text" id="studentInput" placeholder="輸入新學生" style="min-width:150px;">
      <button onclick="addStudent()">新增學生</button>
      <div id="studentCount">👥 共 0 位學生</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>姓名</th>
          <th class="date-header">週一<br><span id="d1">-</span></th>
          <th class="date-header">週二<br><span id="d2">-</span></th>
          <th class="date-header">週三<br><span id="d3">-</span></th>
          <th class="date-header">週四<br><span id="d4">-</span></th>
          <th class="date-header">週五<br><span id="d5">-</span></th>
          <th class="date-header">週六<br><span id="d6">-</span></th>
          <th class="date-header">週日<br><span id="d7">-</span></th>
          <th>刪除</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  <script>
    const yearSelect = document.getElementById("yearSelect");
    const monthSelect = document.getElementById("monthSelect");
    const schoolSelect = document.getElementById("schoolSelect");
    const studentInput = document.getElementById("studentInput");
    const tableBody = document.getElementById("tableBody");
    const titleSchool = document.getElementById("titleSchool");
    const titleCourse = document.getElementById("titleCourse");
    const courseInput = document.getElementById("courseInput");
    const studentCount = document.getElementById("studentCount");

    // 資料結構
    // schoolData = { "學校名": [學生名1, 學生名2, ...], ... }
    // courseMap = { "學校名": "課程名稱", ... }

    let schoolData = JSON.parse(localStorage.getItem("schoolData") || "{}");
    let courseMap = JSON.parse(localStorage.getItem("courseMap") || "{}");
    let selectedSchool = localStorage.getItem("selectedSchool") || Object.keys(schoolData)[0] || "預設學校";

    function initSelectors() {
      const now = new Date();
      const year = now.getFullYear();
      yearSelect.innerHTML = "";
      for (let y = year; y <= year + 5; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.text = `${y} 年`;
        yearSelect.appendChild(opt);
      }
      yearSelect.value = year;

      monthSelect.innerHTML = "";
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.text = `${m} 月`;
        monthSelect.appendChild(opt);
      }
      monthSelect.value = now.getMonth() + 1;

      updateDateHeaders();
    }

    function updateDateHeaders() {
      const y = parseInt(yearSelect.value);
      const m = parseInt(monthSelect.value);

      // 找本月第一天
      let firstDay = new Date(y, m - 1, 1);
      // 找本月最後一天
      let lastDay = new Date(y, m, 0);

      // 計算當週週一（假設週一為一週開始）
      // 若今天不在這個月內，則顯示該年月的第一週週一為基準
      let today = new Date();
      if (today.getFullYear() !== y || (today.getMonth() + 1) !== m) {
        today = firstDay;
      }

      let dayOfWeek = (today.getDay() + 6) % 7; // 週一 = 0
      let monday = new Date(today);
      monday.setDate(today.getDate() - dayOfWeek);

      for (let i = 0; i < 7; i++) {
        const day = new Date(monday);
        day.setDate(monday.getDate() + i);
        const span = document.getElementById(`d${i + 1}`);
        if (day.getFullYear() === y && (day.getMonth() + 1) === m) {
          span.textContent = day.getDate();
        } else {
          span.textContent = "-";
        }
      }
    }

    function saveData() {
      localStorage.setItem("schoolData", JSON.stringify(schoolData));
      localStorage.setItem("courseMap", JSON.stringify(courseMap));
      localStorage.setItem("selectedSchool", selectedSchool);
    }

    function renderSchools() {
      schoolSelect.innerHTML = "";
      Object.keys(schoolData).forEach(school => {
        const opt = document.createElement("option");
        opt.value = school;
        opt.text = school;
        schoolSelect.appendChild(opt);
      });
      if (!schoolData[selectedSchool]) {
        selectedSchool = Object.keys(schoolData)[0] || "預設學校";
        if (!schoolData[selectedSchool]) {
          schoolData[selectedSchool] = [];
        }
        saveData();
      }
      schoolSelect.value = selectedSchool;
    }

    function renderTable() {
      tableBody.innerHTML = "";
      const students = schoolData[selectedSchool] || [];
      studentCount.textContent = `👥 共 ${students.length} 位學生`;
      titleSchool.textContent = selectedSchool;
      titleCourse.textContent = `(${courseMap[selectedSchool] || '尚未設定'})`;
      courseInput.value = courseMap[selectedSchool] || '';

      students.forEach(name => {
        const tr = document.createElement("tr");

        // 姓名欄
        const tdName = document.createElement("td");
        tdName.textContent = name;
        tr.appendChild(tdName);

        // 7天點名欄位 (可點擊切換簽到狀態)
        for (let i = 0; i < 7; i++) {
          const td = document.createElement("td");
          td.classList.add("day-cell");
          // 這裡可擴展成存資料，現在只切換樣式
          td.onclick = () => td.classList.toggle("signed");
          tr.appendChild(td);
        }

        // 刪除按鈕欄
        const tdDel = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "刪除";
        delBtn.className = "danger";
        delBtn.onclick = () => {
          if (confirm(`確定刪除學生：${name}？`)) {
            schoolData[selectedSchool] = students.filter(s => s !== name);
            saveData();
            renderTable();
          }
        };
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);

        tableBody.appendChild(tr);
      });
    }

    function addStudent() {
      const name = studentInput.value.trim();
      if (!name) return alert("請輸入學生姓名");
      if (!schoolData[selectedSchool]) schoolData[selectedSchool] = [];
      if (schoolData[selectedSchool].includes(name)) return alert("學生姓名已存在");
      schoolData[selectedSchool].push(name);
      studentInput.value = "";
      saveData();
      renderTable();
    }

    function addSchool() {
      const name = prompt("請輸入學校名稱");
      if (!name) return;
      if (!schoolData[name]) schoolData[name] = [];
      selectedSchool = name;
      saveData();
      renderSchools();
      renderTable();
    }

    function deleteSchool() {
      if (confirm(`確定刪除學校：${selectedSchool}？`)) {
        delete schoolData[selectedSchool];
        delete courseMap[selectedSchool];
        selectedSchool = Object.keys(schoolData)[0] || "預設學校";
        if (!schoolData[selectedSchool]) schoolData[selectedSchool] = [];
        saveData();
        renderSchools();
        renderTable();
      }
    }

    function setCourse() {
      const input = courseInput.value.trim();
      if (!input) return alert("請輸入課程名稱");
      courseMap[selectedSchool] = input;
      saveData();
      renderTable();
    }

    yearSelect.onchange = () => {
      updateDateHeaders();
    };
    monthSelect.onchange = () => {
      updateDateHeaders();
    };
    schoolSelect.onchange = () => {
      selectedSchool = schoolSelect.value;
      saveData();
      renderTable();
    };

    // 初始化
    initSelectors();
    renderSchools();
    renderTable();
  </script>
</body>
</html>
