<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“š OOå­¸æ ¡ é»åç‰ˆ ğŸ“š</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background: #222;
      color: #fff;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #333;
      border-radius: 12px;
      box-shadow: 0 0 15px #000;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 28px;
      user-select: none;
    }
    .row-2, .row-3 {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      justify-content: flex-start;
      align-items: center;
    }
    .row-2 > *, .row-3 > * {
      flex-shrink: 0;
      font-size: 16px;
    }
    select, input[type=text], button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: #555;
      color: #eee;
      font-size: 16px;
      min-width: 120px;
    }
    input[type=text] {
      min-width: 160px;
    }
    button {
      cursor: pointer;
      background: #4caf50;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #45a049;
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #d32f2f;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      overflow-x: auto;
      table-layout: fixed;
    }
    thead tr th {
      position: sticky;
      top: 0;
      background: #222;
      padding: 10px 6px;
      border: 1px solid #444;
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      z-index: 2;
      text-align: center;
    }
    tbody tr td {
      padding: 8px 6px;
      border: 1px solid #444;
      font-size: 14px;
      white-space: nowrap;
      text-align: center;
      cursor: default;
      min-width: 80px;
    }
    tbody tr td.sticky-name {
      position: sticky;
      left: 0;
      background: #333;
      font-weight: 600;
      text-align: left;
      padding-left: 10px;
      cursor: default;
      min-width: 160px;
      z-index: 1;
      user-select: none;
    }
    tbody tr td.day-cell {
      background: #444;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
    }
    tbody tr td.day-cell.signed {
      background: #81c784;
      color: #000;
      font-weight: 700;
    }
    tbody tr td.delete-cell button {
      background: #f44336;
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    tbody tr td.delete-cell button:hover {
      background: #d32f2f;
    }
    .student-count {
      margin-left: auto;
      font-weight: 600;
      user-select: none;
    }
    @media (max-width: 768px) {
      .row-2, .row-3 {
        flex-direction: column;
        align-items: flex-start;
      }
      select, input[type=text], button {
        min-width: 100%;
      }
      tbody tr td.sticky-name {
        min-width: 140px;
        padding-left: 6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      ğŸ“š <span id="titleSchool">OOå­¸æ ¡</span> 
      <span id="titleCourse">(èª²ç¨‹)</span> 
      <span id="titleTeacher">(æŒ‡å°è€å¸«)</span> 
      é»åç‰ˆ ğŸ“š
    </h1>

    <div class="row-2">
      <select id="schoolSelect" title="åˆ‡æ›å­¸æ ¡"></select>
      <button id="btnAddSchool" type="button">æ–°å¢å­¸æ ¡</button>
      <button id="btnDelSchool" type="button" class="danger">åˆªé™¤å­¸æ ¡</button>
      <input id="courseInput" type="text" placeholder="è«‹è¼¸å…¥èª²ç¨‹åç¨±" title="èª²ç¨‹åç¨±" />
      <button id="btnSetCourse" type="button">è¨­å®šèª²ç¨‹</button>
      <input id="teacherInput" type="text" placeholder="è«‹è¼¸å…¥æŒ‡å°è€å¸«å§“å" title="æŒ‡å°è€å¸«å§“å" />
      <button id="btnSetTeacher" type="button">è¨­å®šæŒ‡å°è€å¸«</button>
    </div>

    <div class="row-3">
      <select id="yearSelect" title="é¸æ“‡å¹´ä»½"></select>
      <select id="monthSelect" title="é¸æ“‡æœˆä»½"></select>
      <select id="weekSelect" title="é¸æ“‡é€±æ¬¡"></select>
      <input id="studentInput" type="text" placeholder="è¼¸å…¥æ–°å­¸ç”Ÿ" title="æ–°å¢å­¸ç”Ÿ" />
      <button id="btnAddStudent" type="button">æ–°å¢å­¸ç”Ÿ</button>
      <div class="student-count" id="studentCount">ğŸ‘¥ å…± 0 ä½å­¸ç”Ÿ</div>
    </div>

    <table id="attendanceTable">
      <thead>
        <tr>
          <th>å§“å</th>
          <th>é€±ä¸€<br><span id="d1">-</span></th>
          <th>é€±äºŒ<br><span id="d2">-</span></th>
          <th>é€±ä¸‰<br><span id="d3">-</span></th>
          <th>é€±å››<br><span id="d4">-</span></th>
          <th>é€±äº”<br><span id="d5">-</span></th>
          <th>é€±å…­<br><span id="d6">-</span></th>
          <th>é€±æ—¥<br><span id="d7">-</span></th>
          <th>åˆªé™¤</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

<script>
  // ä¸»è¦è³‡æ–™å­˜æ”¾ï¼ŒlocalStorageéµå
  const STORAGE_KEY = 'attendanceData_v1';

  // é è¨­è³‡æ–™çµæ§‹
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    schools: {
      'OOå­¸æ ¡': { course: '', teacher: '', students: [], attendance: {} }
    }
  };

  // ç›®å‰é¸æ“‡å­¸æ ¡
  let currentSchool = 'OOå­¸æ ¡';

  // å¹´ã€æœˆã€é€±é è¨­
  let currentYear = null;
  let currentMonth = null;
  let currentWeek = null;

  // å…ƒä»¶åƒè€ƒ
  const titleSchool = document.getElementById('titleSchool');
  const titleCourse = document.getElementById('titleCourse');
  const titleTeacher = document.getElementById('titleTeacher');
  const schoolSelect = document.getElementById('schoolSelect');
  const btnAddSchool = document.getElementById('btnAddSchool');
  const btnDelSchool = document.getElementById('btnDelSchool');
  const courseInput = document.getElementById('courseInput');
  const btnSetCourse = document.getElementById('btnSetCourse');
  const teacherInput = document.getElementById('teacherInput');
  const btnSetTeacher = document.getElementById('btnSetTeacher');
  const yearSelect = document.getElementById('yearSelect');
  const monthSelect = document.getElementById('monthSelect');
  const weekSelect = document.getElementById('weekSelect');
  const studentInput = document.getElementById('studentInput');
  const btnAddStudent = document.getElementById('btnAddStudent');
  const studentCount = document.getElementById('studentCount');
  const tableBody = document.getElementById('tableBody');

  // å„²å­˜è³‡æ–™
  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  // å–å¾—ç•¶å‰å­¸æ ¡è³‡æ–™
  function getCurrentSchoolData() {
    return data.schools[currentSchool];
  }

  // æ›´æ–°å­¸æ ¡ä¸‹æ‹‰é¸å–®
  function refreshSchoolOptions() {
    schoolSelect.innerHTML = '';
    Object.keys(data.schools).forEach(school => {
      const opt = document.createElement('option');
      opt.value = school;
      opt.textContent = school;
      schoolSelect.appendChild(opt);
    });
    if (!data.schools[currentSchool]) {
      currentSchool = Object.keys(data.schools)[0];
    }
    schoolSelect.value = currentSchool;
  }

  // æ–°å¢å­¸æ ¡
  btnAddSchool.onclick = () => {
    const newSchool = prompt('è«‹è¼¸å…¥æ–°å­¸æ ¡åç¨±');
    if (!newSchool) return alert('å­¸æ ¡åç¨±ä¸å¯ç‚ºç©ºï¼');
    if (data.schools[newSchool]) return alert('è©²å­¸æ ¡åç¨±å·²å­˜åœ¨ï¼');
    data.schools[newSchool] = { course: '', teacher: '', students: [], attendance: {} };
    currentSchool = newSchool;
    saveData();
    refreshSchoolOptions();
    renderTable();
  };

  // åˆªé™¤å­¸æ ¡
  btnDelSchool.onclick = () => {
    if (currentSchool === 'OOå­¸æ ¡') return alert('ç„¡æ³•åˆªé™¤é è¨­å­¸æ ¡ OOå­¸æ ¡');
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤å­¸æ ¡ï¼š${currentSchool}ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
    delete data.schools[currentSchool];
    const schools = Object.keys(data.schools);
    currentSchool = schools.length ? schools[0] : 'OOå­¸æ ¡';
    if (!data.schools[currentSchool]) {
      data.schools[currentSchool] = { course: '', teacher: '', students: [], attendance: {} };
    }
    saveData();
    refreshSchoolOptions();
    renderTable();
  };

  // è¨­å®šèª²ç¨‹
  btnSetCourse.onclick = () => {
    const val = courseInput.value.trim();
    if (!val) return alert('èª²ç¨‹åç¨±ä¸å¯ç‚ºç©ºï¼');
    data.schools[currentSchool].course = val;
    saveData();
    renderTable();
  };

  // è¨­å®šæŒ‡å°è€å¸«
  btnSetTeacher.onclick = () => {
    const val = teacherInput.value.trim();
    if (!val) return alert('æŒ‡å°è€å¸«å§“åä¸å¯ç‚ºç©ºï¼');
    data.schools[currentSchool].teacher = val;
    saveData();
    renderTable();
  };

  // åˆ‡æ›å­¸æ ¡äº‹ä»¶
  schoolSelect.onchange = () => {
    currentSchool = schoolSelect.value;
    renderTable();
  };

  // æ–°å¢å­¸ç”Ÿ
  btnAddStudent.onclick = () => {
    const val = studentInput.value.trim();
    if (!val) return alert('å­¸ç”Ÿå§“åä¸å¯ç‚ºç©ºï¼');
    const schoolData = getCurrentSchoolData();
    if (schoolData.students.includes(val)) {
      alert('å­¸ç”Ÿå§“åå·²å­˜åœ¨ï¼');
      return;
    }
    schoolData.students.push(val);
    saveData();
    studentInput.value = '';
    renderTable();
  };

  // åˆªé™¤å­¸ç”Ÿ
  function deleteStudent(name) {
    if (!confirm(`ç¢ºå®šåˆªé™¤å­¸ç”Ÿï¼š${name}ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
    const schoolData = getCurrentSchoolData();
    schoolData.students = schoolData.students.filter(s => s !== name);
    // åŒæ™‚åˆªé™¤è©²å­¸ç”Ÿæ‰€æœ‰é»åç´€éŒ„
    if (schoolData.attendance) {
      Object.keys(schoolData.attendance).forEach(weekKey => {
        if (schoolData.attendance[weekKey]) {
          delete schoolData.attendance[weekKey][name];
        }
      });
    }
    saveData();
    renderTable();
  }

  // ç”¢ç”Ÿå¹´ä»½é¸é … (ç•¶å‰å¹´ä»½èµ· 5å¹´)
  function fillYearOptions() {
    const nowYear = new Date().getFullYear();
    yearSelect.innerHTML = '';
    for (let y = nowYear; y <= nowYear + 5; y++) {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      yearSelect.appendChild(opt);
    }
  }

  // ç”¢ç”Ÿæœˆä»½é¸é … (1~12æœˆ)
  function fillMonthOptions() {
    monthSelect.innerHTML = '';
    for (let m = 1; m <= 12; m++) {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      monthSelect.appendChild(opt);
    }
  }

  // ç”¢ç”Ÿé€±æ¬¡é¸é … 1~5é€±
  function fillWeekOptions() {
    weekSelect.innerHTML = '';
    for (let w = 1; w <= 5; w++) {
      const opt = document.createElement('option');
      opt.value = w;
      opt.textContent = `ç¬¬ ${w} é€±`;
      weekSelect.appendChild(opt);
    }
  }

  // å–å¾—æŒ‡å®šå¹´ä»½æœˆä»½çš„ç•¶é€±æ—¥æœŸï¼ˆé€±ä¸€ï½é€±æ—¥ï¼‰
  function getWeekDates(year, month, week) {
    // å–å¾—è©²æœˆä»½ç¬¬ä¸€å¤©æ—¥æœŸç‰©ä»¶
    const firstDay = new Date(year, month - 1, 1);
    // å–å¾—è©²æœˆä»½ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾ (0-6ï¼Œå‘¨æ—¥=0)
    const firstDayWeekday = firstDay.getDay() === 0 ? 7 : firstDay.getDay();
    // è¨ˆç®—é€±ä¸€çš„æ—¥æœŸï¼Œ(week - 1) * 7 + (1 - firstDayWeekday) + 1
    const mondayDate = 1 + (week - 1) * 7 - (firstDayWeekday - 1);
    let dates = [];
    for (let i = 0; i < 7; i++) {
      let d = new Date(year, month - 1, mondayDate + i);
      dates.push(d);
    }
    return dates;
  }

  // æ›´æ–°æ—¥æœŸæ¨™é¡Œ
  function updateDateHeaders() {
    if (!currentYear || !currentMonth || !currentWeek) return;
    const dates = getWeekDates(currentYear, currentMonth, currentWeek);
    for (let i = 1; i <= 7; i++) {
      const d = dates[i - 1];
      const daySpan = document.getElementById('d' + i);
      if (d.getMonth() + 1 !== currentMonth) {
        daySpan.textContent = '-';
      } else {
        daySpan.textContent = d.getDate();
      }
    }
  }

  // é»åæ ¼é»æ“Šåˆ‡æ›ç°½åˆ°ç‹€æ…‹
  function toggleAttendance(student, dayIndex) {
    const schoolData = getCurrentSchoolData();
    if (!schoolData.attendance[currentWeek]) {
      schoolData.attendance[currentWeek] = {};
    }
    if (!schoolData.attendance[currentWeek][student]) {
      schoolData.attendance[currentWeek][student] = {};
    }
    const currentStatus = schoolData.attendance[currentWeek][student][dayIndex];
    schoolData.attendance[currentWeek][student][dayIndex] = !currentStatus;
    saveData();
    renderTable();
  }

  // æ¸²æŸ“é»åè¡¨
  function renderTable() {
    if (!data.schools[currentSchool]) return;

    const schoolData = getCurrentSchoolData();

    titleSchool.textContent = currentSchool;
    titleCourse.textContent = schoolData.course ? `(${schoolData.course})` : '(èª²ç¨‹)';
    titleTeacher.textContent = schoolData.teacher ? `ï¼ˆæŒ‡å°è€å¸«ï¼š${schoolData.teacher}ï¼‰` : '(æŒ‡å°è€å¸«)';

    courseInput.value = schoolData.course || '';
    teacherInput.value = schoolData.teacher || '';

    studentCount.textContent = `ğŸ‘¥ å…± ${schoolData.students.length} ä½å­¸ç”Ÿ`;

    // å¹´æœˆé€±è¨­å®šé¸æ“‡åˆå§‹å€¼
    if (!currentYear || !yearSelect.querySelector(`option[value="${currentYear}"]`)) {
      currentYear = new Date().getFullYear();
    }
    if (!currentMonth || !monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
      currentMonth = new Date().getMonth() + 1;
    }
    if (!currentWeek || !weekSelect.querySelector(`option[value="${currentWeek}"]`)) {
      currentWeek = 1;
    }

    yearSelect.value = currentYear;
    monthSelect.value = currentMonth;
    weekSelect.value = currentWeek;

    updateDateHeaders();

    // ç”¢ç”Ÿè¡¨æ ¼å…§å®¹
    tableBody.innerHTML = '';
    for (let student of schoolData.students) {
      const tr = document.createElement('tr');

      // å­¸ç”Ÿå§“å(å›ºå®šæ¬„)
      const tdName = document.createElement('td');
      tdName.textContent = student;
      tdName.className = 'sticky-name';
      tr.appendChild(tdName);

      // 7å¤©ç°½åˆ°æ¬„ä½
      for (let day = 1; day <= 7; day++) {
        const td = document.createElement('td');
        td.className = 'day-cell';
        td.dataset.student = student;
        td.dataset.day = day;
        // ç°½åˆ°ç‹€æ…‹
        const signed = schoolData.attendance[currentWeek]
          && schoolData.attendance[currentWeek][student]
          && schoolData.attendance[currentWeek][student][day];
        if (signed) {
          td.classList.add('signed');
          td.textContent = 'âœ”';
        } else {
          td.textContent = '';
        }
        td.onclick = () => toggleAttendance(student, day);
        tr.appendChild(td);
      }

      // åˆªé™¤å­¸ç”ŸæŒ‰éˆ•
      const tdDel = document.createElement('td');
      tdDel.className = 'delete-cell';
      const btnDel = document.createElement('button');
      btnDel.textContent = 'åˆªé™¤';
      btnDel.onclick = () => deleteStudent(student);
      tdDel.appendChild(btnDel);
      tr.appendChild(tdDel);

      tableBody.appendChild(tr);
    }
  }

  // ç›£è½å¹´æœˆé€±ä¸‹æ‹‰æ”¹è®Šäº‹ä»¶
  yearSelect.onchange = () => {
    currentYear = parseInt(yearSelect.value);
    renderTable();
  };
  monthSelect.onchange = () => {
    currentMonth = parseInt(monthSelect.value);
    renderTable();
  };
  weekSelect.onchange = () => {
    currentWeek = parseInt(weekSelect.value);
    renderTable();
  };

  // åˆå§‹åŒ–å‡½å¼
  function init() {
    refreshSchoolOptions();
    fillYearOptions();
    fillMonthOptions();
    fillWeekOptions();

    // é è¨­ç‚ºç•¶å‰æ—¥æœŸå¹´ã€æœˆã€é€±
    const today = new Date();
    currentYear = today.getFullYear();
    currentMonth = today.getMonth() + 1;
    currentWeek = 1; // é è¨­é€±ä¸€é–‹å§‹ï¼Œä½¿ç”¨è€…å¯é¸æ“‡å¾Œèª¿æ•´

    renderTable();
  }

  init();

</script>
</body>
</html>
