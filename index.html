<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“š OOå­¸æ ¡ é»åç‰ˆ ğŸ“š</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #1e1e1e;
    margin: 0;
    padding: 6px;
    display: flex;
    justify-content: center;
  }
  .container {
    width: 100%;
    max-width: 480px;
    background: #2c2c2c;
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
  }
  h2 {
    text-align: center;
    margin: 0 0 8px 0;
    font-size: 20px;
    color: #fff;
    user-select: none;
  }
  /* ç¬¬ä¸€æ’ top-panel: 6æ¬„å‡åˆ† */
  .top-panel {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 4px;
    margin-bottom: 6px;
  }
  /* ç¬¬äºŒæ’ top-panel: èª¿æ•´æ¬„ä½å¯¬åº¦ */
  .top-panel.bottom {
    grid-template-columns: 73px 73px 73px 40px 1fr auto;
    gap: 4px;
  }

  .top-panel input,
  .top-panel select,
  .top-panel button {
    font-size: 13px;
    padding: 6px;
    box-sizing: border-box;
    border-radius: 4px;
    border: none;
    background: #3a3a3a;
    color: #fff;
    text-align: center;
  }
  /* input å’Œ select å¯¬åº¦100%ç”± grid å®¹å™¨æ§åˆ¶ */
  .top-panel input,
  .top-panel select {
    width: 100%;
  }
  /* æŒ‰éˆ•å¯¬åº¦100%ç”± grid æ§åˆ¶ */
  .top-panel button {
    width: 100%;
    background: #4a90e2;
    cursor: pointer;
    transition: background 0.2s;
  }
  .top-panel button:hover {
    background: #357abd;
  }
  #studentCount {
    justify-self: center;
    align-self: center;
    font-size: 13px;
    color: #fff;
    white-space: nowrap;
    text-align: center;
  }
  .table-wrap {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #2c2c2c;
  }
  th, td {
    border: 1px solid #444;
    padding: 6px 4px;
    text-align: center;
    color: #eee;
    font-size: 13px;
    width: 28px;
  }
  th {
    background: #3a3a3a;
  }
  td.sticky-name {
    position: sticky;
    left: 0;
    background: #2c2c2c;
    font-weight: bold;
    width: 80px;
    max-width: 80px;
    min-width: 80px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  td.day-cell {
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
  }
  td.day-cell.signed {
    background: #81c784;
    color: #000;
    font-weight: bold;
  }
  td.day-cell:hover {
    background: #5a875a;
  }
  td.delete-cell {
    width: 60px;
  }
  td.delete-cell button {
    background: #d9534f;
    color: #fff;
    font-size: 11px;
    padding: 4px 6px;
    border-radius: 3px;
    border: none;
    cursor: pointer;
  }
  td.delete-cell button:hover {
    background: #c12e2a;
  }

  /* æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
  @media (max-width: 480px) {
    .top-panel {
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      margin-bottom: 6px;
    }
    .top-panel.bottom {
      grid-template-columns: 73px 73px 73px 40px 1fr auto;
    }
    #yearSelect, #monthSelect, #weekSelect {
      font-size: 14px;
      padding: 4px;
    }
    #studentInput {
      font-size: 12px;
      padding: 4px;
      width: 40px !important; /* ç¢ºä¿æ‰‹æ©Ÿä¹Ÿç¸®åˆ°40px */
    }
    td.day-cell {
      width: 24px;
      height: 24px;
    }
    td.sticky-name {
      width: 70px;
      max-width: 70px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <h2 id="titleHeader">ğŸ“š OOå­¸æ ¡ (èª²ç¨‹) é»åç‰ˆ ğŸ“š</h2>

  <div class="top-panel">
    <select id="schoolSelect"></select>
    <button id="btnAddSchool">æ–°å¢å­¸æ ¡</button>
    <button id="btnDelSchool">åˆªé™¤å­¸æ ¡</button>
    <input id="courseInput" type="text" placeholder="èª²ç¨‹åç¨±" />
    <button id="btnSetCourse">è¨­å®šèª²ç¨‹</button>
    <input id="teacherInput" type="text" placeholder="è€å¸«" />
  </div>

  <div class="top-panel bottom">
    <select id="yearSelect"></select>
    <select id="monthSelect"></select>
    <select id="weekSelect"></select>
    <input id="studentInput" type="text" placeholder="æ–°å¢å­¸ç”Ÿ" />
    <button id="btnAddStudent">æ–°å¢</button>
    <div id="studentCount">ğŸ‘¥ å…± 0 ä½å­¸ç”Ÿ</div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>å­¸ç”Ÿå§“å</th>
          <th id="d1">ä¸€<br>-</th>
          <th id="d2">äºŒ<br>-</th>
          <th id="d3">ä¸‰<br>-</th>
          <th id="d4">å››<br>-</th>
          <th id="d5">äº”<br>-</th>
          <th id="d6">å…­<br>-</th>
          <th id="d7">æ—¥<br>-</th>
          <th>åˆªé™¤</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
const STORAGE_KEY = "attendanceData";
const schoolSelect = document.getElementById("schoolSelect");
const btnAddSchool = document.getElementById("btnAddSchool");
const btnDelSchool = document.getElementById("btnDelSchool");
const courseInput = document.getElementById("courseInput");
const btnSetCourse = document.getElementById("btnSetCourse");
const teacherInput = document.getElementById("teacherInput");
const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const weekSelect = document.getElementById("weekSelect");
const studentInput = document.getElementById("studentInput");
const btnAddStudent = document.getElementById("btnAddStudent");
const studentCount = document.getElementById("studentCount");
const tableBody = document.getElementById("tableBody");
const titleHeader = document.getElementById("titleHeader");

let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
  schools: { "OOå­¸æ ¡": { course:"èª²ç¨‹", teacher:"", students:[], attendance:{} } },
  currentSchool: "OOå­¸æ ¡"
};

function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function initDatePanels() {
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth() + 1;

  yearSelect.innerHTML = "";
  for(let i = y; i <= y + 5; i++) {
    yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
  }

  monthSelect.innerHTML = "";
  for(let i = 1; i <= 12; i++) {
    const v = i.toString().padStart(2, "0");
    monthSelect.innerHTML += `<option value="${v}">${v}</option>`;
  }

  weekSelect.innerHTML = "";
  const weekLabels = ["ä¸€","äºŒ","ä¸‰","å››","äº”"];
  for(let i = 1; i <= 5; i++) {
    weekSelect.innerHTML += `<option value="${i}">${weekLabels[i-1]}</option>`;
  }

  yearSelect.value = y;
  monthSelect.value = m.toString().padStart(2, "0");

  const firstDay = new Date(y, m - 1, 1).getDay();
  const offset = firstDay === 0 ? 6 : firstDay - 1;
  const currentWeek = Math.min(5, Math.floor((now.getDate() + offset - 1) / 7) + 1);
  weekSelect.value = currentWeek;
}

function refreshUI() {
  schoolSelect.innerHTML = Object.keys(data.schools).map(school => `<option value="${school}">${school}</option>`).join("");
  schoolSelect.value = data.currentSchool;
  const info = data.schools[data.currentSchool];
  courseInput.value = info.course || "";
  teacherInput.value = info.teacher ? info.teacher.replace(/è€å¸«$/, "") : "";
  titleHeader.textContent = `ğŸ“š ${data.currentSchool} (${info.course}) é»åç‰ˆ ğŸ“š`;
}

function getWeekDates(y, m, w) {
  const firstDay = new Date(y, m - 1, 1).getDay();
  const offset = firstDay === 0 ? 6 : firstDay - 1;
  const startDate = 1 + (w - 1) * 7 - offset;
  const daysInMonth = new Date(y, m, 0).getDate();
  let dates = [];
  for (let i = 0; i < 7; i++) {
    const d = startDate + i;
    dates.push(d < 1 || d > daysInMonth ? "-" : d);
  }
  return dates;
}

function renderTable() {
  const info = data.schools[data.currentSchool];
  const y = +yearSelect.value;
  const m = +monthSelect.value;
  const w = +weekSelect.value;
  const dates = getWeekDates(y, m, w);

  for(let i=1; i<=7; i++){
    document.getElementById("d"+i).innerHTML = ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"][i-1] + "<br>" + dates[i-1];
  }

  const key = `${yearSelect.value}-${monthSelect.value}-${weekSelect.value}`;
  const att = info.attendance[key] || {};

  tableBody.innerHTML = "";
  info.students.forEach(name => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="sticky-name">${name}</td>` +
      [...Array(7).keys()].map(i => {
        const checked = att[name]?.[i];
        return `<td class="day-cell ${checked ? "signed" : ""}">${checked ? "âœ”ï¸" : ""}</td>`;
      }).join("") +
      `<td class="delete-cell"><button>åˆªé™¤</button></td>`;

    const dayCells = tr.querySelectorAll(".day-cell");
    dayCells.forEach((td, i) => {
      td.onclick = () => {
        att[name] = att[name] || [false,false,false,false,false,false,false];
        att[name][i] = !att[name][i];
        info.attendance[key] = att;
        saveData();
        renderTable();
      };
    });

    tr.querySelector("button").onclick = () => {
      if (confirm(`åˆªé™¤å­¸ç”Ÿï¼š${name}?`)) {
        info.students = info.students.filter(n => n !== name);
        for (const k in info.attendance) {
          delete info.attendance[k][name];
        }
        saveData();
        renderTable();
      }
    };

    tableBody.appendChild(tr);
  });

  studentCount.textContent = `ğŸ‘¥ å…± ${info.students.length} ä½å­¸ç”Ÿ`;
}

// æ–°å¢å­¸æ ¡
btnAddSchool.onclick = () => {
  const n = prompt("æ–°å­¸æ ¡åç¨±:");
  if (n && !data.schools[n]) {
    data.schools[n] = { course: "èª²ç¨‹", teacher: "", students: [], attendance: {} };
    data.currentSchool = n;
    saveData();
    refreshUI();
    renderTable();
  }
};

// åˆªé™¤å­¸æ ¡
btnDelSchool.onclick = () => {
  if (data.currentSchool !== "OOå­¸æ ¡" && confirm(`åˆªé™¤å­¸æ ¡ã€Œ${data.currentSchool}ã€?`)) {
    delete data.schools[data.currentSchool];
    data.currentSchool = Object.keys(data.schools)[0];
    saveData();
    refreshUI();
    renderTable();
  }
};

// è¨­å®šèª²ç¨‹åŠè€å¸«
btnSetCourse.onclick = () => {
  const info = data.schools[data.currentSchool];
  info.course = courseInput.value;
  info.teacher = teacherInput.value.trim() + "è€å¸«";
  saveData();
  refreshUI();
  alert("è¨­å®šå®Œæˆ");
};

// åˆ‡æ›å­¸æ ¡æ™‚æ›´æ–°ç•«é¢åŠè³‡æ–™
schoolSelect.onchange = () => {
  data.currentSchool = schoolSelect.value;
  saveData();
  refreshUI();
  renderTable();
};

// è€å¸«è¼¸å…¥å³æ™‚ä¿å­˜
teacherInput.addEventListener("input", () => {
  const info = data.schools[data.currentSchool];
  info.teacher = teacherInput.value.trim() + "è€å¸«";
  saveData();
});

// æ–°å¢å­¸ç”Ÿ
btnAddStudent.onclick = () => {
  const v = studentInput.value.trim();
  if (v) {
    const s = data.schools[data.currentSchool].students;
    if (!s.includes(v)) {
      s.push(v);
      saveData();
      renderTable();
      studentInput.value = "";
    } else {
      alert("å­¸ç”Ÿå·²å­˜åœ¨");
    }
  }
};

// å¹´/æœˆ/é€±æ”¹è®Šé‡ç¹ªè¡¨æ ¼
yearSelect.onchange = monthSelect.onchange = weekSelect.onchange = renderTable;

initDatePanels();
refreshUI();
renderTable();
</script>
</body>
</html>
