<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“š OOå­¸æ ¡ é»åç‰ˆ ğŸ“š</title>
<style>
  /* æ•´é«”èƒŒæ™¯èˆ‡å®¹å™¨ */
  body {
    font-family: Arial, sans-serif;
    background: #1e1e1e;
    margin: 0;
    padding: 6px;
    display: flex;
    justify-content: center;
  }
  .container {
    width: 100%;
    max-width: 480px;
    background: #2c2c2c;
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
  }
  h2 {
    text-align: center;
    margin: 0 0 8px 0;
    font-size: 20px;
    color: #fff;
    line-height: 1.2;
    user-select: none;
  }
  /* ä¸Šæ–¹é¢æ¿ */
  .top-panel {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 4px;
    margin-bottom: 6px;
  }
  .top-panel input,
  .top-panel select,
  .top-panel button {
    font-size: 13px;
    padding: 6px;
    width: 100%;
    box-sizing: border-box;
    border-radius: 4px;
    border: none;
    background: #3a3a3a;
    color: #fff;
  }
  .top-panel button {
    background: #4a90e2;
    cursor: pointer;
    transition: background 0.2s;
  }
  .top-panel button:hover {
    background: #357abd;
  }
  #teacherInput {
    text-align: center;
  }
  #courseInput {
    text-align: center;
  }
  #studentCount {
    grid-column: 6 / 7;
    justify-self: end;
    font-size: 13px;
    color: #fff;
    white-space: nowrap;
  }
  /* è¡¨æ ¼ */
  .table-wrap {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #2c2c2c;
  }
  th, td {
    border: 1px solid #444;
    padding: 6px 4px;
    text-align: center;
    color: #eee;
    font-size: 13px;
  }
  th {
    background: #3a3a3a;
  }
  /* å›ºå®šå§“åæ¬„ */
  td.sticky-name {
    position: sticky;
    left: 0;
    background: #2c2c2c;
    font-weight: bold;
    min-width: 100px;
    max-width: 120px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  /* é»åæ ¼ */
  td.day-cell {
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
  }
  td.day-cell.signed {
    background: #81c784;
    color: #000;
    font-weight: bold;
  }
  td.day-cell:hover {
    background: #5a875a;
  }
  /* åˆªé™¤æŒ‰éˆ• */
  td.delete-cell button {
    background: #d9534f;
    color: #fff;
    font-size: 11px;
    padding: 4px 6px;
    border-radius: 3px;
    border: none;
    cursor: pointer;
  }
  td.delete-cell button:hover {
    background: #c12e2a;
  }
  @media (max-width: 480px) {
    .top-panel {
      grid-template-columns: repeat(3, 1fr);
    }
    td.day-cell {
      width: 24px;
      height: 24px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <h2 id="titleHeader">ğŸ“š OOå­¸æ ¡ (èª²ç¨‹) é»åç‰ˆ ğŸ“š</h2>

  <div class="top-panel">
    <select id="schoolSelect"></select>
    <button id="btnAddSchool">æ–°å¢å­¸æ ¡</button>
    <button id="btnDelSchool">åˆªé™¤å­¸æ ¡</button>
    <input id="courseInput" type="text" placeholder="èª²ç¨‹åç¨±" />
    <button id="btnSetCourse">è¨­å®šèª²ç¨‹</button>
    <input id="teacherInput" type="text" placeholder="è€å¸«" />
  </div>

  <div class="top-panel">
    <select id="yearSelect"></select>
    <select id="monthSelect"></select>
    <select id="weekSelect"></select>
    <input id="studentInput" type="text" placeholder="æ–°å¢å­¸ç”Ÿ" />
    <button id="btnAddStudent">æ–°å¢</button>
    <div id="studentCount">ğŸ‘¥ å…± 0 ä½å­¸ç”Ÿ</div>
  </div>

  <div class="table-wrap">
    <table><thead><tr>
      <th>å­¸ç”Ÿå§“å</th>
      <th id="d1">ä¸€<br>-</th><th id="d2">äºŒ<br>-</th>
      <th id="d3">ä¸‰<br>-</th><th id="d4">å››<br>-</th>
      <th id="d5">äº”<br>-</th><th id="d6">å…­<br>-</th>
      <th id="d7">æ—¥<br>-</th><th>åˆªé™¤</th>
    </tr></thead><tbody id="tableBody"></tbody></table>
  </div>
</div>

<script>
// æœ¬åœ°å­˜å„² key
const STORAGE_KEY = "attendanceData";

// å–å¾— DOM
const schoolSelect = document.getElementById("schoolSelect");
const btnAddSchool = document.getElementById("btnAddSchool");
const btnDelSchool = document.getElementById("btnDelSchool");
const courseInput = document.getElementById("courseInput");
const btnSetCourse = document.getElementById("btnSetCourse");
const teacherInput = document.getElementById("teacherInput");
const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const weekSelect = document.getElementById("weekSelect");
const studentInput = document.getElementById("studentInput");
const btnAddStudent = document.getElementById("btnAddStudent");
const studentCount = document.getElementById("studentCount");
const tableBody = document.getElementById("tableBody");
const titleHeader = document.getElementById("titleHeader");

// åˆå§‹è³‡æ–™
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
  schools: { "OOå­¸æ ¡": { course:"èª²ç¨‹", teacher:"", students:[], attendance:{} } },
  currentSchool: "OOå­¸æ ¡"
};

// å­˜è³‡æ–™
function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// å…ƒä»¶åˆå§‹åŒ–
function initDatePanels() {
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth() + 1;

  yearSelect.innerHTML = "";
  for(let i=y; i<=y+5; i++){
    yearSelect.innerHTML += `<option value="${i}">${i} å¹´</option>`;
  }
  monthSelect.innerHTML = "";
  for(let i=1;i<=12;i++){
    const v=i.toString().padStart(2,'0');
    monthSelect.innerHTML += `<option value="${v}">${i} æœˆ</option>`;
  }
  weekSelect.innerHTML = "";
  for(let i=1;i<=5;i++){
    weekSelect.innerHTML += `<option value="${i}">ç¬¬ ${i} é€±</option>`;
  }

  yearSelect.value = y;
  monthSelect.value = m.toString().padStart(2,'0');

  // é è¨­é€±æ¬¡ = ä»Šæ—¥é€±æ¬¡ï¼ˆé€±ä¸€ç‚ºèµ·ï¼‰
  const first = new Date(y, m-1, 1).getDay();
  const offset = first===0?6:first-1;
  const w = Math.min(5, Math.floor((now.getDate()+offset-1)/7)+1);
  weekSelect.value = w;
}

// æ›´æ–°å­¸æ ¡é¸å–®èˆ‡æ¨™é¡Œ
function refreshUI(){
  schoolSelect.innerHTML = "";
  for(const name of Object.keys(data.schools)){
    schoolSelect.innerHTML += `<option value="${name}">${name}</option>`;
  }
  schoolSelect.value = data.currentSchool;

  const info = data.schools[data.currentSchool];
  courseInput.value = info.course;
  teacherInput.value = info.teacher;
  titleHeader.textContent = `ğŸ“š ${data.currentSchool} (${info.course}) é»åç‰ˆ ğŸ“š`;
}

// ç®—æ¯é€±æ—¥æœŸ
function getWeekDates(y, m, w){
  const first = new Date(y, m-1,1).getDay();
  const offset = first===0?6:first-1;
  const start = 1 + (w-1)*7 - offset;
  const days = new Date(y, m, 0).getDate();
  let arr=[];
  for(let i=0;i<7;i++){
    const d = start+i;
    arr.push(d<1||d>days ? "-" : d);
  }
  return arr;
}

// æ¸²æŸ“é»åèˆ‡æ ¼
function renderTable(){
  const info = data.schools[data.currentSchool];
  const y = +yearSelect.value;
  const m = +monthSelect.value;
  const w = +weekSelect.value;

  const dates = getWeekDates(y, m, w);
  for(let i=1;i<=7;i++){
    document.getElementById("d"+i).innerHTML = ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"][i-1] + "<br>" + dates[i-1];
  }

  const key = `${yearSelect.value}-${monthSelect.value}-${weekSelect.value}`;
  const att = info.attendance[key] || {};

  tableBody.innerHTML = "";
  info.students.forEach(name=>{
    const tr = document.createElement("tr");
    const tdName = document.createElement("td");
    tdName.className="sticky-name";
    tdName.textContent = name;
    tr.appendChild(tdName);

    for(let i=0;i<7;i++){
      const td = document.createElement("td");
      td.className="day-cell";
      td.textContent = att[name]?.[i]? "âœ”ï¸": "";
      if(att[name]?.[i]) td.classList.add("signed");
      td.onclick = ()=>{
        data.schools[data.currentSchool].attendance[key] = att;
        if(!att[name]) att[name]=[false,false,false,false,false,false,false];
        att[name][i] = !att[name][i];
        saveData();
        renderTable();
      };
      tr.appendChild(td);
    }

    const tdDel = document.createElement("td");
    tdDel.className="delete-cell";
    const btn = document.createElement("button");
    btn.textContent="åˆªé™¤";
    btn.onclick = ()=>{
      if(confirm(`åˆªé™¤å­¸ç”Ÿï¼š${name}?`)){
        const idx = info.students.indexOf(name);
        info.students.splice(idx,1);
        saveData();
        renderTable();
      }
    };
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);

    tableBody.appendChild(tr);
  });

  studentCount.textContent = `ğŸ‘¥ å…± ${info.students.length} ä½å­¸ç”Ÿ`;
}

// æ–°å¢å­¸æ ¡
btnAddSchool.onclick = ()=>{
  const n=prompt("æ–°å­¸æ ¡åç¨±:");
  if(n && !data.schools[n]){
    data.schools[n]={course:"èª²ç¨‹",teacher:"",students:[],attendance:{}};
    data.currentSchool=n;
    saveData(); refreshUI(); renderTable();
  }
};

// åˆªé™¤å­¸æ ¡
btnDelSchool.onclick = ()=>{
  if(data.currentSchool!=="OOå­¸æ ¡"
     && confirm(`åˆªé™¤å­¸æ ¡ã€Œ${data.currentSchool}ã€?`)){
    delete data.schools[data.currentSchool];
    data.currentSchool = Object.keys(data.schools)[0];
    saveData(); refreshUI(); renderTable();
  }
};

// è¨­å®šèª²ç¨‹èˆ‡è€å¸«
btnSetCourse.onclick = ()=>{
  const info = data.schools[data.currentSchool];
  info.course = courseInput.value;
  info.teacher = teacherInput.value + "è€å¸«";
  saveData(); refreshUI(); alert("è¨­å®šå®Œæˆ");
};

// åˆ‡æ›å­¸æ ¡
schoolSelect.onchange = ()=>{
  data.currentSchool = schoolSelect.value;
  saveData(); refreshUI(); renderTable();
};

// æ–°å¢å­¸ç”Ÿ
btnAddStudent.onclick = ()=>{
  const v=studentInput.value.trim();
  if(v){
    const s = data.schools[data.currentSchool].students;
    if(!s.includes(v)){
      s.push(v);
      saveData(); renderTable();
      studentInput.value="";
    } else alert("å­¸ç”Ÿå·²å­˜åœ¨");
  }
};

// æ—¥æœŸæ§åˆ¶è®Šæ›´åˆ·æ–°
yearSelect.onchange = monthSelect.onchange = weekSelect.onchange = renderTable;

// åˆå§‹åŒ–
initDatePanels();
refreshUI();
renderTable();
</script>
</body>
</html>
